require 'fileutils'

class PassetsController <  ApplicationController
  
  protect_from_forgery

  before_filter :authenticate_user!
   
  def index
    @assets = current_user.passets.all
  end

  def destroy
    fn = FileTools.sanitize_filename(params[:uuid])
    current_user.passets.delete_all(uuid: uuid)
    # remove file
    
  end 

  def create
    tmp = params[:file_upload][:my_file].tempfile
    logger.debug("Got file #{tmp.path}")
    @uuid=`uuidgen`.strip
    fileinfo = `file #{tmp.path}`.strip
    
    @file = "#{UPLOADS_DIR}/#{@uuid}"
    
    # TODO: Only accept a limited number of extensions and types
    # mp3, mov, mp4, mp3, avi
    # block m4p (they are protected)
    # TODO: Additional filename sanitization
    # TODO: Use md5 to find out if we've seen this before, don't allow dupes?
    
    # build the object
    @p = Passet.new(uuid: @uuid, 
                    filename: FileTools.sanitize_filename(params[:file_upload][:my_file].original_filename), 
                    kind: fileinfo, 
                    sound_cue: params[:file_upload][:cue],	
                    light_cue: params[:file_upload][:cue],	
                    pnotes: params[:file_upload][:notes])

    current_user.passets << @p
    
    # move it into place
    # TODO: Distribute data across directories
    logger.debug("copy #{tmp.path} to #{@file}")
    logger.debug("file is #{fileinfo}")
    FileUtils.cp tmp.path, @file
    FileUtils.rm tmp.path
  end

end
  
