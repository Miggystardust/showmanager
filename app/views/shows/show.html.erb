<p id="notice"><%= notice %></p>
<h3><%= @show.title %> @ <%= @show.venue %></h3>

<P>
  <b>Door time:</b>
  <%= @show.door_time.strftime(SHORT_TIME_FMT) %>
  <b>Show time:</b>
  <%= @show.show_time.strftime(SHORT_TIME_FMT) %>
</p>

<h3>Show Schedule</h3>
<P>
<button class="btn btn-success btn-small" id="refreshBtn">
<i class="icon-refresh icon-white"></i> Refresh </button>
</p>
<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" id="showlist">
<thead>
<TR>
<TH width=50>Seq</TH>
<TH>Time</TH>
<TH>Act</TH>
<TH>Sound</TH>
<TH>Light + Stage</TH>
<TH>Notes</TH>
</TR>
</thead>
<tbody>
<!-- data -->
</tbody>
</TABLE>

<script>

$.extend( $.fn.dataTableExt.oStdClasses, {
    "sSortAsc": "header headerSortDown",
    "sSortDesc": "header headerSortUp",
    "sSortable": "header"
} );

$.extend( $.fn.dataTableExt.oStdClasses, {
    "sWrapper": "dataTables_wrapper form-inline"
} );

/* set up acts datatable */
$(document).ready(function() {
  var intervalId;

  showDT = $('#showlist').dataTable( {
      "sDom": "<'row'<'span12'l><'span12'f>r>t<'row'<'span6'i><'span12'p>>",
        "sAjaxSource": "/shows/<%=@show.id%>/show_items.json",
        "sPagination": "bootstrap",
        "iDisplayLength": 100,
        "oLanguage": {
        "sLengthMenu": "Show&nbsp;<select size=1 name=actslist_length aria-controls=\"actslist\"><option value='10'>10</option><option value='50'>50</option><option value='100'>100</option></select>&nbsp;records per page"
          },
        "fnServerData": function ( sSource, aoData, fnCallback ) {
          $.ajax({'datatype':'json',
                'type':'GET',
                'url':sSource,
                'data':aoData,
                'success':function(json) {               
                    fnCallback(json);
                    if (! intervalId) { 
                      intervalId = setInterval(function() { showDT.fnReloadAjax(); }, 2000);
                    }

              }});
        }
    });

 /* wireup some ajax reloads on these tables - when this was enabled we were getting duplicate rows... */

  /* set up the lower table */
  var fixHelper = function(e, ui) {
    ui.children().each(function() {
        $(this).width($(this).width());
      });
    return ui;
  };
  
  $("#sort tbody").sortable({
    helper: fixHelper
        }).disableSelection();
  
  /* this delegated event handler works, but needs to go down one level. */
  $("#actslist tbody").delegate("td", "click", function() {
      if ($(".actadder", this)[0] != undefined) { 
        var clicked_id = $(".actadder", this)[0].id;
        var actdata = {
          'show_id':'<%=@show.id%>',
          'kind': '32',
          'act_id': clicked_id,
          "authenticity_token" : AUTH_TOKEN
        };
      
        $.ajax({
          type: 'POST',
              dataType: 'json',
              url: '/show_items.json',
              contentType: 'application/json',
              data: JSON.stringify(actdata),
              success: function() { 
                showDT.fnReloadAjax();
              }
          });
      }
    });

  $("#showlist tbody").delegate("td", "click", function() {
      if ($(".siremove", this)[0] != undefined) { 
        var clicked_id = $(".siremove", this)[0].id;
        var actdata = {
          "authenticity_token" : AUTH_TOKEN
        };
      
        $.ajax({
          type: 'DELETE',
              dataType: 'json',
              url: '/show_items/' + clicked_id + '.json',
              contentType: 'application/json',
              data: JSON.stringify(actdata),
              success: function() { 
                showDT.fnReloadAjax();
              }
          });
      }
    });


  /* add act clicks */
  $(document).ready( function () { 
	  $("#refreshBtn").click( function (e) {
          e.preventDefault();
          showDT.fnReloadAjax();
      });
     
      $("#editFormToggle").click( function (e) {
          e.preventDefault();
          $(".toggle-icon").toggleClass('ui-icon-triangle-1-e');		
          $(".toggle-icon").toggleClass('ui-icon-triangle-1-s');
          $("#metadataform").slideToggle();
          
          if ($(".toggle-icon").hasClass("ui-icon-triangle-1-s")) { 
            $("#toggle-txt").html("Hide Details");
          } else {
            $("#toggle-txt").html("Edit Show Details");
          }
        });

      $("#actFormToggle").click( function (e) {
          e.preventDefault();
          $(".toggle-act-icon").toggleClass('ui-icon-triangle-1-e');		
          $(".toggle-act-icon").toggleClass('ui-icon-triangle-1-s');
          $("#actTable").slideToggle();
          
          if ($(".toggle-act-icon").hasClass("ui-icon-triangle-1-s")) { 
            $("#act-toggle-txt").html("Hide Act List");
          } else {
            $("#act-toggle-txt").html("Show Act List");
          }
        });

    });
  });
  
</script>


<%= link_to 'Edit', edit_show_path(@show) %> |
<%= link_to 'Back', shows_path %>
